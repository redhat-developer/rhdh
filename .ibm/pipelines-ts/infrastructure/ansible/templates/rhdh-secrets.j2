apiVersion: v1
kind: Secret
metadata:
  name: rhdh-secrets
  namespace: {{ namespace }}
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: rhdh
type: Opaque
data:
  # Base URL configuration
  BACKEND_SECRET: {{ backend_secret | default('default-secret') | b64encode }}
  RHDH_BASE_URL: {{ (router_base | default('localhost')) | b64encode }}
  RHDH_BASE_URL_HTTP: {{ (router_base | default('localhost') | replace('https://', 'http://')) | b64encode }}
  
  # Database configuration
{% if postgresql_enabled %}
  POSTGRES_HOST: {{ postgresql_host | b64encode }}
  POSTGRES_PORT: {{ postgresql_port | default('5432') | string | b64encode }}
  POSTGRES_USER: {{ postgresql_user | b64encode }}
  POSTGRES_PASSWORD: {{ postgresql_password | b64encode }}
  POSTGRES_DB: {{ postgresql_database | default('backstage') | b64encode }}
{% endif %}

  # Redis configuration
{% if redis_enabled %}
  REDIS_HOST: {{ redis_host | default('redis-master') | b64encode }}
  REDIS_PORT: {{ redis_port | default('6379') | string | b64encode }}
{% if redis_password %}
  REDIS_PASSWORD: {{ redis_password | b64encode }}
{% endif %}
{% endif %}

  # GitHub configuration
{% if github_auth_enabled %}
  GITHUB_CLIENT_ID: {{ github_client_id | b64encode }}
  GITHUB_CLIENT_SECRET: {{ github_client_secret | b64encode }}
{% if github_token %}
  GITHUB_TOKEN: {{ github_token | b64encode }}
{% endif %}
{% if github_webhook_secret %}
  GITHUB_WEBHOOK_SECRET: {{ github_webhook_secret | b64encode }}
{% endif %}
{% endif %}

  # Kubernetes cluster configuration
{% if kubernetes_plugin_enabled %}
  K8S_CLUSTER_TOKEN: {{ k8s_cluster_token | b64encode }}
  K8S_CLUSTER_URL: {{ k8s_cluster_url | b64encode }}
{% if k8s_cluster_ca_data %}
  K8S_CLUSTER_CA_DATA: {{ k8s_cluster_ca_data | b64encode }}
{% endif %}
{% endif %}

  # ArgoCD configuration
{% if argocd_plugin_enabled %}
  ARGOCD_URL: {{ argocd_url | b64encode }}
  ARGOCD_TOKEN: {{ argocd_token | b64encode }}
  ARGOCD_USERNAME: {{ argocd_username | default('admin') | b64encode }}
  ARGOCD_PASSWORD: {{ argocd_password | b64encode }}
{% endif %}

  # Azure DevOps configuration
{% if azure_devops_enabled %}
  AZURE_TOKEN: {{ azure_devops_token | b64encode }}
  AZURE_ORG: {{ azure_devops_org | b64encode }}
{% endif %}

  # GitLab configuration  
{% if gitlab_enabled %}
  GITLAB_TOKEN: {{ gitlab_token | b64encode }}
  GITLAB_BASE_URL: {{ gitlab_base_url | default('https://gitlab.com') | b64encode }}
{% endif %}

  # Keycloak/OIDC configuration
{% if keycloak_enabled %}
  KEYCLOAK_BASE_URL: {{ keycloak_base_url | b64encode }}
  KEYCLOAK_REALM: {{ keycloak_realm | default('backstage') | b64encode }}
  KEYCLOAK_CLIENT_ID: {{ keycloak_client_id | b64encode }}
  KEYCLOAK_CLIENT_SECRET: {{ keycloak_client_secret | b64encode }}
{% endif %}

  # SonarQube configuration
{% if sonarqube_enabled %}
  SONARQUBE_URL: {{ sonarqube_url | b64encode }}
  SONARQUBE_TOKEN: {{ sonarqube_token | b64encode }}
{% endif %}

  # Prometheus configuration
{% if prometheus_enabled %}
  PROMETHEUS_URL: {{ prometheus_url | b64encode }}
{% endif %}

  # Grafana configuration
{% if grafana_enabled %}
  GRAFANA_URL: {{ grafana_url | b64encode }}
  GRAFANA_TOKEN: {{ grafana_token | b64encode }}
{% endif %}

  # Custom secrets
{% if custom_secrets %}
{% for key, value in custom_secrets.items() %}
  {{ key }}: {{ value | b64encode }}
{% endfor %}
{% endif %}

  # Environment-specific secrets
{% if cluster_type == 'openshift' %}
  OPENSHIFT_CLUSTER_TOKEN: {{ openshift_cluster_token | default(k8s_cluster_token) | b64encode }}
{% elif cluster_type == 'aks' %}
  AZURE_SUBSCRIPTION_ID: {{ azure_subscription_id | b64encode }}
  AZURE_RESOURCE_GROUP: {{ azure_resource_group | b64encode }}
{% elif cluster_type == 'gke' %}
  GOOGLE_CLOUD_PROJECT: {{ google_cloud_project | b64encode }}
  GOOGLE_APPLICATION_CREDENTIALS: {{ google_application_credentials | b64encode }}
{% endif %}

---
# ServiceAccount Token Secret for K8s Plugin
{% if kubernetes_plugin_enabled %}
apiVersion: v1
kind: Secret
metadata:
  name: rhdh-k8s-plugin-secret
  namespace: {{ namespace }}
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: k8s-plugin
    app.kubernetes.io/part-of: rhdh
type: Opaque
data:
  token: {{ k8s_cluster_token | b64encode }}
{% endif %}

---
# Database Connection Secret (if external database)
{% if postgresql_enabled and postgresql_external %}
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-secret
  namespace: {{ namespace }}
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: rhdh
type: Opaque
data:
  postgres-password: {{ postgresql_password | b64encode }}
  password: {{ postgresql_password | b64encode }}
  username: {{ postgresql_user | b64encode }}
  database: {{ postgresql_database | default('backstage') | b64encode }}
{% endif %} 